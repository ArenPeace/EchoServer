# 分布式理论专题

## 分布式理论
### CAP理论
+ Consistency 一致性  
分布式集群中，对同一数据的多个备份的访问是一致的
+ Availability 可用性  
任何请求都能得到正确的响应，不完全保证获取的数据为最新
+ Partition tolerance 分区容错性  
分布式集群中，一部分节点故障，整体仍然可用  

实际效果，跨区跨机房的服务通信失败很正常（丢包、延时），如果不能在有限时间内完成通信，则发生异常，分区不可用。所以，分布式设计中一定会考虑分区容错。
CAP三者不可得兼，舍一存二（PC/PA）。
经典关系数据库的事务一致性、读写实时性、多表关联查询等很多特性在Web2.0被选择性抛弃了。

**CAP和NoSQL**  
NoSQL更注重性能和可扩展性，而非事务机制（经典关系数据库支持ACID强事务性）。
NoSQL仅提供行级别的原子性保证，即对同一`key-value`操作两次，是串行处理，保证ACID。

**Base理论**  
1. 基本可用 Basically Available
允许部分不可用，整体或核心可用
2. 软状态 Soft State
允许不同节点间副本间同步延时，不影响整体可用。
3. 最终一致性 Eventually Consistency
所有副本最终一致。

Base的思想是即使做不到强一致性，也要达到最终一致性。
这样，分布式的多个副本可以异步复制，达到高性能和最终一致。
最终一致性需要保障用户感知的一致性，用户的不一致窗口取决于通信延时/系统负载/副本复制个数。

DNS是典型的最终一致性。

*acid为酸，base为碱

### Paxos算法
paxos算法是LaTex开发者计算机科学家 莱斯利 兰伯特 提出的，一种基于消息传递且具有高度容错特性的共识（consensus）算法（共识算法不是为了达到一致性，而是分区高度容错的消息传递机制）。

+ 首先将议员的角色分为 proposers，acceptors，和 learners（允许身兼数职）。
+ proposers 提出提案，提案信息包括提案编号和提议的 value；
+ acceptor 收到提案后可以接受（accept）提案，若提案获得多数派（majority）的 acceptors 的接受，则称该提案被批准（chosen）；
+ learners 只能“学习”被批准的提案。

划分角色后，就可以更精确的定义问题：
+ 决议（value）只有在被 proposers 提出后才能被批准（未经批准的决议称为“提案（proposal）”）；
+ 在一次 Paxos 算法的执行实例中，只批准（chosen）一个 value；
+ learners 只能获得被批准（chosen）的 value。

**quorum机制？**

*zk集群的zab协议基于paxos，但并没有完全实现。
### Raft算法
raft算法是要提供更好理解的共识算法，并提供与paxos相同的容错和性能。

Raft透过选举领袖（leader）的方式实做共识算法。

在Raft集群（Raft cluster）里，服务器可能会是这三种身份其中一个：领袖（leader）、追随者（follower），或是候选人（candidate）。在正常情况下只会有一个领袖，其他都是追随者。而领袖会负责所有外部的请求，如果不是领袖的机器收到时，请求会被导到领袖。

通常领袖会借由固定时间发送消息，也就是“心跳（英语：heartbeat）”，让追随者知道集群的领袖还在运作。而每个追随者都会设计超时机制（timeout），当超过一定时间没有收到心跳（通常是150 ms或300 ms），集群就会进入选举状态。

Raft将问题拆成数个子问题分开解决，让人更容易了解：
+ 领袖选举（Leader Election）
+ 记录复写（Log Replication）
+ 安全性（Safety）

## 分布式管理
### zookeeper

### etcd
